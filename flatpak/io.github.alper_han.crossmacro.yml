app-id: io.github.alper_han.crossmacro
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.dotnet10
command: crossmacro

finish-args:
  # X11 Access (Required for XTest, XInput2)
  - --share=ipc
  - --socket=x11
  
  # Detect keyboard layout on KDE Plasma
  - --talk-name=org.kde.keyboard
  
  # User files (macro save/load)
  - --filesystem=xdg-documents/crossmacro:create

  # GPU Acceleration (Recommended for Avalonia UI)
  - --device=dri

  # .NET runtime location
  - --env=DOTNET_ROOT=/app/lib/dotnet

build-options:
  prepend-path: /usr/lib/sdk/dotnet10/bin
  append-ld-library-path: /usr/lib/sdk/dotnet10/lib
  prepend-pkg-config-path: /usr/lib/sdk/dotnet10/lib/pkgconfig
  env:
    DOTNET_CLI_TELEMETRY_OPTOUT: 'true'
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'

modules:
  # .NET Runtime Installation (Framework-Dependent approach)
  - name: dotnet
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/dotnet10/bin/install.sh

  - name: crossmacro
    buildsystem: simple
    build-commands:
      # Copy all app files to lib directory (keeps DLLs together with binary)
      - mkdir -p /app/lib/crossmacro
      - cp -r * /app/lib/crossmacro/ || true
      - chmod +x /app/lib/crossmacro/CrossMacro.UI
      
      # Install launcher script
      - install -Dm755 crossmacro.sh /app/bin/crossmacro
      
      # Desktop entry
      - install -Dm644 io.github.alper_han.crossmacro.desktop /app/share/applications/io.github.alper_han.crossmacro.desktop
      
      # Icons
      - install -Dm644 icons/512x512/apps/crossmacro.png /app/share/icons/hicolor/512x512/apps/io.github.alper_han.crossmacro.png
      - install -Dm644 icons/256x256/apps/crossmacro.png /app/share/icons/hicolor/256x256/apps/io.github.alper_han.crossmacro.png
      - install -Dm644 icons/128x128/apps/crossmacro.png /app/share/icons/hicolor/128x128/apps/io.github.alper_han.crossmacro.png
      
      # Metainfo
      - install -Dm644 io.github.alper_han.crossmacro.metainfo.xml /app/share/metainfo/io.github.alper_han.crossmacro.metainfo.xml
      
      # License
      - install -Dm644 LICENSE /app/share/licenses/io.github.alper_han.crossmacro/LICENSE

    sources:
      - type: dir
        path: ../scripts/flatpak-source
